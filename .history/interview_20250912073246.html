<!DOCTYPE html>
<html lang="en" ng-app="interviewApp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interview | Prepare.com</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Antique&family=Share+Tech&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interview.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script> <!-- (g) Animations -->
  <style>
    .question-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 20px auto;
      max-width: 1000px;
      flex-wrap: nowrap;
    }

    .question-box {
      background-color: #9CA2CD;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 4px 4px 0px #999;
      font-family: 'Shippori Antique', sans-serif;
      flex: 1;
    }

    .skip-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      width: 60px;
    }

    .skip-icon img {
      width: 40px;
      height: 40px;
    }

    .skip-icon p {
      font-size: 14px;
      margin-top: 5px;
      font-family: 'Share Tech', sans-serif;
      color: #333;
      text-align: center;
    }

    .skip-icon:hover img {
      transform: scale(1.1);
    }
  </style>
</head>
<body ng-controller="InterviewController">
  <div class="interview-wrapper" ng-init="init()">
    <header class="interview-header">
      <h1>Prepare.com</h1>
    </header>
    <div class="timer-container" ng-show="interviewStarted">
  <p class="timer">Time Left: {{ timeLeft | date:'mm:ss' }}</p>
</div>

    <div class="video-container" ng-show="cameraEnabled">
      <video id="videoFeed" autoplay muted playsinline></video>
    </div>

    <div class="control-icons">
      <button ng-click="toggleMic()">
        <i class="fas" ng-class="micEnabled ? 'fa-microphone' : 'fa-microphone-slash'"></i>
      </button>
      <button ng-click="toggleCamera()">
        <i class="fas" ng-class="cameraEnabled ? 'fa-camera-slash' : 'fa-camera'"></i>
      </button>
    </div>

    <div class="question-section">
      <div class="question-box" ng-animate="'fade'">
        <p class="label">Here is your question...</p>
        <p class="question">{{ question | uppercase }}</p>
      </div>
      <div class="skip-icon" ng-click="skipQuestion()">
        <img src="https://img.icons8.com/?size=100&id=iPavQHIGU2Wk&format=png&color=000000" alt="Skip Icon"/>
        <p>Skip</p>
      </div>
    </div>

    <div class="finish-container">
      <button class="finish-btn" ng-click="finishInterview()">Finish</button>
    </div>
  </div>

  <script>
    var app = angular.module('interviewApp', ['ngAnimate']);

    app.service('QuestionService', ['$http', function($http) {
  this.getQuestion = function() {
    return $http.get("http://localhost:5000/api/questions/random")
      .then(function(response) {
        return response.data.text; // only question text
      })
      .catch(function(err) {
        console.error("Error fetching question:", err);
        return "⚠️ Unable to load question";
      });
  };
}]);


    app.factory('VideoFactory', function() {
      return {
        startCamera: function(videoElement) {
          return navigator.mediaDevices.getUserMedia({
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }
          }).then(stream => {
            videoElement.srcObject = stream;
          });
        },
        stopCamera: function(videoElement) {
          if (videoElement.srcObject) {
            videoElement.srcObject.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
          }
        }
      };
    });

   app.controller('InterviewController', ['$scope', 'QuestionService', 'VideoFactory', function($scope, QuestionService, VideoFactory) {
  $scope.micEnabled = true;
  $scope.cameraEnabled = false;
  $scope.question = "";

  // 👇 Timer values
  $scope.interviewStarted = true;
  $scope.totalInterviewMinutes = 60; // or 30
  $scope.timeLeft = new Date($scope.totalInterviewMinutes * 60000);

  let interviewTimer;

  // ⏱️ Timer start logic
  $scope.startInterviewTimer = function () {
    const interval = 1000; // 1 sec
    interviewTimer = setInterval(() => {
      $scope.timeLeft = new Date($scope.timeLeft.getTime() - interval);
      $scope.$apply();

      const minutesLeft = $scope.timeLeft.getMinutes();
      const secondsLeft = $scope.timeLeft.getSeconds();

      if ($scope.timeLeft.getTime() <= 0) {
        clearInterval(interviewTimer);
        alert("⏰ Interview Time is Over!");
        $scope.finishInterview();
      }
    }, interval);
  };

  // ✅ Init with question + start timer
  $scope.init = function() {
    $scope.question = QuestionService.getQuestion();
    $scope.startInterviewTimer();
  };

  $scope.toggleMic = function() {
    $scope.micEnabled = !$scope.micEnabled;
  };

  $scope.toggleCamera = function() {
    const video = document.getElementById('videoFeed');
    $scope.cameraEnabled = !$scope.cameraEnabled;

    if ($scope.cameraEnabled) {
      VideoFactory.startCamera(video);
    } else {
      VideoFactory.stopCamera(video);
    }
  };

  $scope.finishInterview = function () {
  const elapsed = ($scope.totalInterviewMinutes * 60000) - $scope.timeLeft.getTime();
  const elapsedMinutes = Math.floor(elapsed / 60000);

  if (elapsedMinutes < 10) {
    alert("You must attend at least 10 minutes before finishing!");
    return;
  }

  alert("Interview Finished. Redirecting to scorecard...");
  clearInterval(interviewTimer);
  window.location.href = "scorecard.html"; // or Angular route
};


  $scope.skipQuestion = function () {
    $scope.question = "Tell me about a challenge you faced in your last project.";
  };
}]);


    app.directive('questionCard', function() {
      return {
        restrict: 'E',
        template: '<div class="question-box"><p class="label">Here is your question...</p><p class="question">{{ question }}</p></div>'
      };
    });
  </script>
</body>
</html>